name: Update downloads.json

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-downloads:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch GitHub downloads
        run: |
          GH_TOTAL=$(curl -s https://api.github.com/repos/Mealman1551/ArchivedDataCodec/releases | jq '[.[] .assets[].download_count] | add // 0')
          echo "GH_TOTAL=$GH_TOTAL" >> $GITHUB_ENV

      - name: Fetch SourceForge downloads
        run: |
          TODAY=$(date +%F)
          curl -s "https://sourceforge.net/projects/adc-archiver/files/stats/json?start_date=2010-01-01&end_date=$TODAY" > sf.json

          SF_TOTAL=$(jq '
            if has("downloads") then
              [.downloads[] | to_entries[] | select(.value | type=="number") | .value] | add // 0
            else 0 end
          ' sf.json)

          echo "SF_TOTAL=$SF_TOTAL" >> $GITHUB_ENV

      - name: Create downloads.json
        run: |
          TOTAL=$(($GH_TOTAL + $SF_TOTAL))
          mkdir -p .github
          echo "{\"total_downloads\": $TOTAL, \"github\": $GH_TOTAL, \"sourceforge\": $SF_TOTAL}" > .github/downloads.json

      - name: Commit downloads.json
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .github/downloads.json
          git commit -m "Update download stats" || echo "Nothing to commit"
          git push
